<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Bệnh Viện</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #eff6ff; color: #2563eb; border-right: 4px solid #2563eb; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Table sticky header */
        thead th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-xl flex flex-col z-20">
        <div class="p-6 border-b flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">
                <i class="fa-solid fa-hospital"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg">Bệnh viện Sơn Hùng Khánh Quyết</h1>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <div onclick="renderView('dashboard')" id="nav-dashboard" class="sidebar-item px-6 py-3 cursor-pointer text-gray-600 font-medium flex items-center gap-3 active">
                <i class="fa-solid fa-chart-pie w-5"></i> Tổng quan
            </div>
            <div onclick="renderView('doctors')" id="nav-doctors" class="sidebar-item px-6 py-3 cursor-pointer text-gray-600 font-medium flex items-center gap-3">
                <i class="fa-solid fa-user-doctor w-5"></i> Bác sĩ
            </div>
            <div onclick="renderView('patients')" id="nav-patients" class="sidebar-item px-6 py-3 cursor-pointer text-gray-600 font-medium flex items-center gap-3">
                <i class="fa-solid fa-bed-pulse w-5"></i> Bệnh nhân
            </div>
            <div onclick="renderView('employees')" id="nav-employees" class="sidebar-item px-6 py-3 cursor-pointer text-gray-600 font-medium flex items-center gap-3">
                <i class="fa-solid fa-users w-5"></i> Nhân viên
            </div>
            <div onclick="renderView('rooms')" id="nav-rooms" class="sidebar-item px-6 py-3 cursor-pointer text-gray-600 font-medium flex items-center gap-3">
                <i class="fa-solid fa-door-open w-5"></i> Phòng bệnh
            </div>
            <div onclick="renderView('schedules')" id="nav-schedules" class="sidebar-item px-6 py-3 cursor-pointer text-gray-600 font-medium flex items-center gap-3">
                <i class="fa-solid fa-calendar-check w-5"></i> Lịch khám
            </div>
        </nav>

        
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        <!-- Header -->
        <header class="h-16 bg-white shadow-sm flex items-center justify-between px-8 z-10">
            <h2 id="page-title" class="text-xl font-bold text-gray-800 flex items-center gap-2">
                Tổng quan hệ thống
            </h2>
            <div class="flex items-center gap-4">
                <button onclick="renderView('booking')" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white px-5 py-2 rounded-lg text-sm font-medium transition shadow-md flex items-center gap-2 transform hover:scale-105">
                    <i class="fa-solid fa-plus-circle"></i> Đặt lịch khám ngay
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content" class="flex-1 overflow-y-auto p-8 relative bg-gray-50">
            <!-- Dynamic Content will be injected here -->
        </div>
    </main>

    <!-- Modal Template -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 id="modal-title" class="font-bold text-lg text-gray-800">Tiêu đề Modal</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Form fields -->
            </div>
            <div class="p-5 border-t bg-gray-50 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium text-sm transition">Hủy bỏ</button>
                <button id="modal-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> Lưu & Tải File
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden File Inputs for Import -->
    <input type="file" id="file-doctors" class="hidden" onchange="handleFileUpload(this, 'doctors')">
    <input type="file" id="file-patients" class="hidden" onchange="handleFileUpload(this, 'patients')">
    <input type="file" id="file-employees" class="hidden" onchange="handleFileUpload(this, 'employees')">
    <input type="file" id="file-rooms" class="hidden" onchange="handleFileUpload(this, 'rooms')">
    <input type="file" id="file-schedules" class="hidden" onchange="handleFileUpload(this, 'schedules')">

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-4 rounded-lg shadow-xl transform translate-y-40 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 border-l-4 border-green-500">
        <i class="fa-solid fa-circle-check text-green-400 text-xl"></i>
        <div>
            <h4 class="font-bold text-sm">Thành công</h4>
            <span id="toast-msg" class="text-sm text-gray-300">Thông báo</span>
        </div>
    </div>

<script>
    // --- DATA STATE ---
    const DB = {
        doctors: [],
        patients: [],
        employees: [],
        rooms: [],
        schedules: []
    };

    // --- INITIALIZATION ---
    function initDB() {
        const stored = localStorage.getItem('hospitalDB');
        if (stored) {
            const parsed = JSON.parse(stored);
            DB.doctors = parsed.doctors || [];
            DB.patients = parsed.patients || [];
            DB.employees = parsed.employees || [];
            DB.rooms = parsed.rooms || [];
            DB.schedules = parsed.schedules || [];
        } else {
            // Sample Data
            DB.rooms = [
                { id: 'P101', type: 'Kham benh', status: 1 },
                { id: 'P102', type: 'Hoi suc', status: 1 },
                { id: 'P201', type: 'Phau thuat', status: 0 }
            ];
            DB.doctors = [
                { id: 'BS1', name: 'Nguyen Van A', dob: '01/01/1980', addr: 'Ha Noi', phone: '0901234567', pos: 'Truong khoa', spec: 'Noi khoa', salary: 5.0 }
            ];
            saveDB();
        }
        renderView('dashboard');
    }

    function saveDB() {
        localStorage.setItem('hospitalDB', JSON.stringify(DB));
    }

    // --- UTILS ---
    function generateID(prefix, list, idKey = 'id') {
        let maxVal = 0;
        list.forEach(item => {
            const idStr = item[idKey] || "";
            if (idStr.startsWith(prefix)) {
                const numPart = parseInt(idStr.replace(prefix, ""));
                if (!isNaN(numPart) && numPart > maxVal) maxVal = numPart;
            }
        });
        return prefix + (maxVal + 1);
    }
    
    function generateRoomID(floor) {
        const prefix = "P" + floor;
        let maxSuffix = 0;
        DB.rooms.forEach(r => {
            if(r.id.startsWith(prefix)) {
                 const suffix = parseInt(r.id.substring(prefix.length));
                 if(!isNaN(suffix) && suffix > maxSuffix) maxSuffix = suffix;
            }
        });
        const next = maxSuffix + 1;
        return prefix + (next < 10 ? '0' + next : next);
    }

    // --- RENDER CONTROLLER ---
    function renderView(viewName) {
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'border-r-4', 'border-blue-600'));
        const navItem = document.getElementById(`nav-${viewName}`);
        if(navItem) navItem.classList.add('active', 'bg-blue-50', 'text-blue-600', 'border-r-4', 'border-blue-600');
        
        const content = document.getElementById('content');
        const title = document.getElementById('page-title');

        switch(viewName) {
            case 'dashboard':
                title.innerHTML = '<i class="fa-solid fa-chart-pie text-blue-600"></i> Dashboard Tổng Quan';
                content.innerHTML = renderDashboard();
                break;
            case 'doctors':
                title.innerHTML = '<i class="fa-solid fa-user-doctor text-blue-600"></i> Quản Lý Bác Sĩ';
                content.innerHTML = renderTable('doctors');
                break;
            case 'patients':
                title.innerHTML = '<i class="fa-solid fa-bed-pulse text-green-600"></i> Quản Lý Bệnh Nhân';
                content.innerHTML = renderTable('patients');
                break;
            case 'employees':
                title.innerHTML = '<i class="fa-solid fa-users text-gray-600"></i> Quản Lý Nhân Viên';
                content.innerHTML = renderTable('employees');
                break;
            case 'rooms':
                title.innerHTML = '<i class="fa-solid fa-door-open text-yellow-600"></i> Quản Lý Phòng Bệnh';
                content.innerHTML = renderTable('rooms');
                break;
            case 'schedules':
                title.innerHTML = '<i class="fa-solid fa-calendar-check text-purple-600"></i> Lịch Khám Bệnh';
                content.innerHTML = renderTable('schedules');
                break;
            case 'booking':
                title.innerHTML = '<i class="fa-solid fa-plus-circle text-blue-600"></i> Đặt Lịch Khám Mới';
                content.innerHTML = renderBookingPage();
                break;
        }
    }

    // --- COMPONENT RENDERERS ---

    function renderDashboard() {
        const freeRooms = DB.rooms.filter(r => r.status == 1).length;
        return `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate-fade-in-up">
                <div class="card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Bác sĩ</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1">${DB.doctors.length}</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl"><i class="fa-solid fa-user-doctor"></i></div>
                </div>
                <div class="card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Bệnh nhân</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1">${DB.patients.length}</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl"><i class="fa-solid fa-bed-pulse"></i></div>
                </div>
                <div class="card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Phòng trống</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1">${freeRooms} <span class="text-sm text-gray-400 font-normal">/ ${DB.rooms.length}</span></h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-xl"><i class="fa-solid fa-door-open"></i></div>
                </div>
                <div class="card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Tổng lịch khám</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1">${DB.schedules.length}</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xl"><i class="fa-solid fa-calendar-check"></i></div>
                </div>
            </div>

            <!-- Thống kê hoạt động Bác Sĩ -->
             <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:col-span-2">
                     <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-history text-blue-500"></i> Lịch sử khám gần đây</h3>
                     <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-gray-500 text-sm border-b bg-gray-50">
                                    <th class="py-2 px-2 font-medium">Ngày</th>
                                    <th class="py-2 px-2 font-medium">Bác sĩ</th>
                                    <th class="py-2 px-2 font-medium">Bệnh nhân</th>
                                    <th class="py-2 px-2 font-medium">Phòng</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm text-gray-700">
                                ${DB.schedules.slice(-5).reverse().map(s => `
                                <tr class="border-b last:border-0 hover:bg-gray-50">
                                    <td class="py-3 px-2">${s.date}</td>
                                    <td class="py-3 px-2 font-medium text-blue-600">${s.docId}</td>
                                    <td class="py-3 px-2">${s.patId}</td>
                                    <td class="py-3 px-2"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${s.roomId}</span></td>
                                </tr>
                                `).join('')}
                                ${DB.schedules.length === 0 ? '<tr><td colspan="4" class="py-4 text-center text-gray-400">Chưa có dữ liệu</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-user-md text-blue-500"></i> Top Bác sĩ bận rộn</h3>
                    <div class="space-y-4">
                        ${getDoctorStats().slice(0, 5).map(stat => `
                            <div class="flex items-center justify-between border-b pb-2 last:border-0">
                                <div>
                                    <p class="font-medium text-sm text-gray-800">${stat.name}</p>
                                    <p class="text-xs text-gray-500">ID: ${stat.id}</p>
                                </div>
                                <div class="text-right">
                                    <span class="block font-bold text-blue-600">${stat.count}</span>
                                    <span class="text-xs text-gray-400">lịch khám</span>
                                </div>
                            </div>
                        `).join('')}
                         ${DB.doctors.length === 0 ? '<p class="text-gray-400 text-sm">Chưa có dữ liệu bác sĩ</p>' : ''}
                    </div>
                </div>
             </div>
        `;
    }

    function getDoctorStats() {
        return DB.doctors.map(doc => {
            const count = DB.schedules.filter(s => s.docId === doc.id).length;
            return { id: doc.id, name: doc.name, count: count };
        }).sort((a,b) => b.count - a.count);
    }
    
    function getDoctorWorkDays(docId) {
        const dates = DB.schedules.filter(s => s.docId === docId).map(s => s.date);
        return new Set(dates).size;
    }

    function renderTable(type) {
        let headers = [];
        let rows = [];
        
        let controlBar = `
            <div class="flex gap-2">
                <button onclick="document.getElementById('file-${type}').click()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg text-sm shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-file-import text-orange-500"></i> Nhập File
                </button>
                <button onclick="exportFile('${type}')" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg text-sm shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-file-export text-green-600"></i> Xuất File
                </button>
                <button onclick="openModal('${type}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm shadow-md flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Thêm Mới
                </button>
            </div>
        `;

        if (type === 'doctors') {
            headers = ['ID', 'Họ Tên', 'Ngày sinh', 'Chuyên khoa', 'Chức vụ', 'Số ca khám', 'Số ngày công', 'Thao tác'];
            rows = DB.doctors.map(d => {
                const shiftCount = DB.schedules.filter(s => s.docId === d.id).length;
                const dayCount = getDoctorWorkDays(d.id);
                return `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="py-3 px-4 font-medium text-blue-600">${d.id}</td>
                    <td class="py-3 px-4 font-medium text-gray-800">${d.name}</td>
                    <td class="py-3 px-4 text-gray-500">${d.dob}</td>
                    <td class="py-3 px-4"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded-md text-xs font-semibold border border-blue-100">${d.spec}</span></td>
                    <td class="py-3 px-4 text-gray-600">${d.pos}</td>
                    <td class="py-3 px-4 text-center font-bold text-gray-700">${shiftCount}</td>
                    <td class="py-3 px-4 text-center font-bold text-green-600">${dayCount}</td>
                    <td class="py-3 px-4 flex gap-3">
                        <button onclick="openModal('${type}', '${d.id}')" class="text-gray-400 hover:text-blue-600 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteItem('${type}', '${d.id}')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        } else if (type === 'patients') {
            headers = ['ID', 'Họ Tên', 'Ngày sinh', 'Chẩn đoán', 'Nhóm máu', 'SĐT', 'Thao tác'];
            rows = DB.patients.map(p => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="py-3 px-4 font-medium text-green-600">${p.id}</td>
                    <td class="py-3 px-4 font-medium text-gray-800">${p.name}</td>
                    <td class="py-3 px-4 text-gray-500">${p.dob}</td>
                    <td class="py-3 px-4 text-gray-600 italic max-w-xs truncate">${p.diag}</td>
                    <td class="py-3 px-4"><span class="bg-red-50 text-red-700 px-2 py-1 rounded-full text-xs font-bold border border-red-100">${p.blood}</span></td>
                    <td class="py-3 px-4 text-gray-600">${p.phone}</td>
                    <td class="py-3 px-4 flex gap-3">
                        <button onclick="openModal('${type}', '${p.id}')" class="text-gray-400 hover:text-blue-600 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteItem('${type}', '${p.id}')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        } else if (type === 'employees') {
            headers = ['ID', 'Họ Tên', 'Ngày sinh', 'Chức vụ', 'SĐT', 'Thao tác'];
            rows = DB.employees.map(e => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="py-3 px-4 font-medium text-gray-600">${e.id}</td>
                    <td class="py-3 px-4 font-medium text-gray-800">${e.name}</td>
                    <td class="py-3 px-4 text-gray-500">${e.dob}</td>
                    <td class="py-3 px-4 text-gray-600">${e.pos}</td>
                    <td class="py-3 px-4 text-gray-600">${e.phone}</td>
                    <td class="py-3 px-4 flex gap-3">
                        <button onclick="openModal('${type}', '${e.id}')" class="text-gray-400 hover:text-blue-600 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteItem('${type}', '${e.id}')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        } else if (type === 'rooms') {
            headers = ['ID Phòng', 'Loại Phòng', 'Trạng thái', 'Thao tác'];
            rows = DB.rooms.map(r => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="py-3 px-4 font-bold text-gray-700 font-mono">${r.id}</td>
                    <td class="py-3 px-4 text-gray-600">${r.type}</td>
                    <td class="py-3 px-4">
                        ${r.status == 1 
                            ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-medium border border-green-200">● Trống</span>' 
                            : '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-medium border border-red-200">● Đang dùng</span>'}
                    </td>
                    <td class="py-3 px-4 flex gap-3">
                        <button onclick="openModal('${type}', '${r.id}')" class="text-gray-400 hover:text-blue-600 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteItem('${type}', '${r.id}')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        } else if (type === 'schedules') {
            controlBar = `
                <div class="flex gap-2">
                     <button onclick="exportFile('${type}')" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg text-sm shadow-sm flex items-center gap-2">
                        <i class="fa-solid fa-file-export text-green-600"></i> Xuất File
                    </button>
                    <button onclick="renderView('booking')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm shadow-md flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Đặt Lịch Mới
                    </button>
                </div>
            `;
            headers = ['Ngày khám', 'Bác sĩ', 'Bệnh nhân', 'Phòng', 'Trạng thái'];
            rows = DB.schedules.map(s => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="py-3 px-4 font-medium text-gray-700">${s.date}</td>
                    <td class="py-3 px-4 text-blue-600 font-medium">${s.docId}</td>
                    <td class="py-3 px-4 text-green-600 font-medium">${s.patId}</td>
                    <td class="py-3 px-4 font-mono bg-gray-50 rounded">${s.roomId}</td>
                    <td class="py-3 px-4"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs border border-blue-200 font-bold">Đã đặt</span></td>
                </tr>
            `).join('');
        }

        return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full">
                <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-700 uppercase text-xs tracking-wider">Dữ liệu hệ thống</h3>
                    ${controlBar}
                </div>
                <div class="overflow-auto flex-1">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b shadow-sm">
                                ${headers.map(h => `<th class="py-3 px-4 font-semibold">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="text-sm text-gray-700 divide-y divide-gray-100">
                            ${rows.length > 0 ? rows : `<tr><td colspan="${headers.length}" class="py-12 text-center text-gray-400 flex flex-col items-center justify-center gap-2"><i class="fa-solid fa-folder-open text-2xl opacity-50"></i><span>Chưa có dữ liệu</span></td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function renderBookingPage() {
        const docOpts = DB.doctors.map(d => `<option value="${d.id}">${d.id} - ${d.name} (${d.spec})</option>`).join('');
        const patOpts = DB.patients.map(p => `<option value="${p.id}">${p.id} - ${p.name}</option>`).join('');

        return `
            <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden animate-fade-in-up">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-8 text-white text-center">
                    <h2 class="text-2xl font-bold">Đặt Lịch Khám</h2>
                    <p class="opacity-90 text-sm mt-2">Hệ thống sẽ tự động tìm phòng trống phù hợp nhất (Logic C++)</p>
                </div>
                <div class="p-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">1. Chọn Bệnh Nhân</label>
                            <div class="relative">
                                <i class="fa-solid fa-bed-pulse absolute left-3 top-3 text-gray-400"></i>
                                <select id="book-pat" class="w-full border border-gray-300 rounded-lg pl-10 p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-gray-50">
                                    <option value="">-- Chọn bệnh nhân --</option>
                                    ${patOpts}
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">2. Chọn Bác Sĩ</label>
                            <div class="relative">
                                <i class="fa-solid fa-user-doctor absolute left-3 top-3 text-gray-400"></i>
                                <select id="book-doc" class="w-full border border-gray-300 rounded-lg pl-10 p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-gray-50">
                                    <option value="">-- Chọn bác sĩ --</option>
                                    ${docOpts}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">3. Chọn Ngày Khám (dd/mm/yyyy)</label>
                        <div class="relative">
                            <i class="fa-solid fa-calendar absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="book-date" placeholder="VD: 20/10/2023" class="w-full border border-gray-300 rounded-lg pl-10 p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-gray-50">
                        </div>
                    </div>

                    <div class="pt-4 border-t">
                        <button onclick="processBooking()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg shadow-lg transform transition active:scale-95 flex justify-center items-center gap-2">
                            <i class="fa-solid fa-check-circle"></i> Xác Nhận Đặt Lịch
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // --- MODAL SYSTEM ---

    function openModal(type, id = null) {
        const modal = document.getElementById('modal');
        const content = document.getElementById('modal-content');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        const saveBtn = document.getElementById('modal-save-btn');
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);

        let data = {};
        if (id) {
            data = DB[type].find(i => i.id === id) || {};
            title.innerHTML = `<i class="fa-solid fa-pen-to-square text-blue-500"></i> Chỉnh sửa ${type}`;
        } else {
            title.innerHTML = `<i class="fa-solid fa-plus-circle text-green-500"></i> Thêm mới vào ${type}`;
        }

        // Form Generators
        let html = '';
        const inputClass = "w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 text-sm";
        const labelClass = "block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wide";

        if (type === 'doctors') {
            html = `
                ${id ? `<div class="mb-4"><label class="${labelClass}">ID (Không đổi)</label><input disabled value="${id}" class="${inputClass} bg-gray-200 cursor-not-allowed text-gray-500"></div>` : ''}
                <div class="mb-4"><label class="${labelClass}">Họ Tên</label><input id="inp-name" value="${data.name||''}" class="${inputClass}" placeholder="Nhập họ tên..."></div>
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Ngày sinh</label><input id="inp-dob" value="${data.dob||''}" placeholder="dd/mm/yyyy" class="${inputClass}"></div>
                    <div><label class="${labelClass}">SĐT</label><input id="inp-phone" value="${data.phone||''}" class="${inputClass}"></div>
                </div>
                <div class="mb-4"><label class="${labelClass}">Địa chỉ</label><input id="inp-addr" value="${data.addr||''}" class="${inputClass}"></div>
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Chức vụ</label><input id="inp-pos" value="${data.pos||''}" class="${inputClass}"></div>
                    <div><label class="${labelClass}">Chuyên khoa</label><input id="inp-spec" value="${data.spec||''}" class="${inputClass}"></div>
                </div>
                <div class="mb-4"><label class="${labelClass}">Hệ số lương</label><input id="inp-sal" type="number" step="0.1" value="${data.salary||''}" class="${inputClass}"></div>
            `;
        } else if (type === 'patients') {
            html = `
                ${id ? `<div class="mb-4"><label class="${labelClass}">ID</label><input disabled value="${id}" class="${inputClass} bg-gray-200 cursor-not-allowed"></div>` : ''}
                <div class="mb-4"><label class="${labelClass}">Họ Tên</label><input id="inp-name" value="${data.name||''}" class="${inputClass}"></div>
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Ngày sinh</label><input id="inp-dob" value="${data.dob||''}" class="${inputClass}"></div>
                    <div><label class="${labelClass}">SĐT</label><input id="inp-phone" value="${data.phone||''}" class="${inputClass}"></div>
                </div>
                <div class="mb-4"><label class="${labelClass}">Địa chỉ</label><input id="inp-addr" value="${data.addr||''}" class="${inputClass}"></div>
                <div class="mb-4"><label class="${labelClass}">Chẩn đoán</label><input id="inp-diag" value="${data.diag||''}" class="${inputClass}"></div>
                <div class="mb-4"><label class="${labelClass}">Nhóm máu</label><input id="inp-blood" value="${data.blood||''}" class="${inputClass}" placeholder="A, B, O..."></div>
            `;
        } else if (type === 'rooms') {
            if (!id) {
                html = `
                    <div class="bg-blue-50 p-3 rounded mb-4 text-xs text-blue-700 border border-blue-200">Hệ thống sẽ tự động tạo ID: P + Tầng + Số thứ tự</div>
                    <div class="mb-4"><label class="${labelClass}">Số Tầng (Ví dụ: 1)</label><input id="inp-floor" type="number" class="${inputClass}" placeholder="Nhập số tầng..."></div>
                    <div class="mb-4"><label class="${labelClass}">Loại Phòng</label><input id="inp-type" class="${inputClass}" placeholder="Kham benh, Hoi suc..."></div>
                `;
            } else {
                 html = `
                    <div class="mb-4"><label class="${labelClass}">ID Phòng</label><input disabled value="${id}" class="${inputClass} bg-gray-200"></div>
                    <div class="mb-4"><label class="${labelClass}">Loại Phòng</label><input id="inp-type" value="${data.type||''}" class="${inputClass}"></div>
                    <div class="mb-4"><label class="${labelClass}">Trạng thái</label>
                        <select id="inp-status" class="${inputClass}">
                            <option value="1" ${data.status==1?'selected':''}>Trống</option>
                            <option value="0" ${data.status==0?'selected':''}>Đang bận</option>
                        </select>
                    </div>
                `;
            }
        } else if (type === 'employees') {
             html = `
                ${id ? `<div class="mb-4"><label class="${labelClass}">ID</label><input disabled value="${id}" class="${inputClass} bg-gray-200 cursor-not-allowed"></div>` : ''}
                <div class="mb-4"><label class="${labelClass}">Họ Tên</label><input id="inp-name" value="${data.name||''}" class="${inputClass}"></div>
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Ngày sinh</label><input id="inp-dob" value="${data.dob||''}" class="${inputClass}"></div>
                    <div><label class="${labelClass}">SĐT</label><input id="inp-phone" value="${data.phone||''}" class="${inputClass}"></div>
                </div>
                <div class="mb-4"><label class="${labelClass}">Địa chỉ</label><input id="inp-addr" value="${data.addr||''}" class="${inputClass}"></div>
                <div class="mb-4"><label class="${labelClass}">Vị trí</label><input id="inp-pos" value="${data.pos||''}" class="${inputClass}"></div>
                <div class="mb-4"><label class="${labelClass}">Hệ số lương</label><input id="inp-sal" type="number" step="0.1" value="${data.salary||''}" class="${inputClass}"></div>
            `;
        }
        
        body.innerHTML = html;
        saveBtn.onclick = () => saveData(type, id);
    }

    function closeModal() {
        const modal = document.getElementById('modal');
        const content = document.getElementById('modal-content');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }

    // --- LOGIC ADD/EDIT & AUTO SAVE ---

    function saveData(type, id) {
        let newData = {};

        // Validation simple
        const nameInp = document.getElementById('inp-name');
        if(type !== 'rooms' && nameInp && !nameInp.value.trim()) {
            alert("Tên không được để trống!"); return;
        }

        if (type === 'doctors') {
            newData = {
                id: id || generateID("BS", DB.doctors),
                name: document.getElementById('inp-name').value,
                dob: document.getElementById('inp-dob').value,
                addr: document.getElementById('inp-addr').value,
                phone: document.getElementById('inp-phone').value,
                pos: document.getElementById('inp-pos').value,
                spec: document.getElementById('inp-spec').value,
                salary: document.getElementById('inp-sal').value
            };
        } else if (type === 'patients') {
             newData = {
                id: id || generateID("BN", DB.patients),
                name: document.getElementById('inp-name').value,
                dob: document.getElementById('inp-dob').value,
                addr: document.getElementById('inp-addr').value,
                phone: document.getElementById('inp-phone').value,
                diag: document.getElementById('inp-diag').value,
                blood: document.getElementById('inp-blood').value
            };
        } else if (type === 'employees') {
             newData = {
                id: id || generateID("NV", DB.employees),
                name: document.getElementById('inp-name').value,
                dob: document.getElementById('inp-dob').value,
                addr: document.getElementById('inp-addr').value,
                phone: document.getElementById('inp-phone').value,
                pos: document.getElementById('inp-pos').value,
                salary: document.getElementById('inp-sal').value
            };
        } else if (type === 'rooms') {
            if (id) {
                // Editing
                const idx = DB.rooms.findIndex(r => r.id === id);
                if (idx !== -1) {
                    DB.rooms[idx].type = document.getElementById('inp-type').value;
                    DB.rooms[idx].status = document.getElementById('inp-status').value;
                }
            } else {
                // Adding
                const floor = document.getElementById('inp-floor').value;
                if(!floor) { alert("Vui lòng nhập tầng!"); return; }
                const newID = generateRoomID(floor);
                newData = {
                    id: newID,
                    type: document.getElementById('inp-type').value,
                    status: 1
                };
            }
        }

        if (type !== 'rooms' || !id) { // Rooms logic for edit handled inside
            if (id) {
                const index = DB[type].findIndex(x => x.id === id);
                if(index !== -1) DB[type][index] = newData;
            } else {
                DB[type].push(newData);
            }
        }

        saveDB();
        closeModal();
        renderView(type);
        showToast("Đã lưu & Cập nhật file!");
        
        // AUTO EXPORT AFTER SAVE (As requested)
        // "sau đó nếu có chỉnh sửa thì sẽ hiện nút ok và file sẽ được tự động tải về máy"
        exportFile(type);
    }

    function deleteItem(type, id) {
        if(confirm(`Bạn có chắc muốn xóa bản ghi ${id}? Hành động này sẽ cập nhật lại file của bạn.`)) {
            DB[type] = DB[type].filter(x => x.id !== id);
            saveDB();
            renderView(type);
            showToast("Đã xóa & Cập nhật file!");
            exportFile(type); // Auto export on delete too
        }
    }

    // --- BOOKING LOGIC (MATCHING C++) ---
    function processBooking() {
        const patId = document.getElementById('book-pat').value;
        const docId = document.getElementById('book-doc').value;
        const date = document.getElementById('book-date').value;

        if (!patId || !docId || !date) {
            alert("Vui lòng nhập đầy đủ thông tin!");
            return;
        }

        // 1. Check busy doctor
        const isBusy = DB.schedules.some(s => s.docId === docId && s.date === date);
        if (isBusy) {
            alert("Bác sĩ đã có lịch hẹn vào ngày này! Vui lòng chọn ngày khác.");
            return;
        }

        // 2. Find best room (Status=1, Type contains "Kham", Lowest ID)
        let bestRoom = null;
        let bestRoomIdx = -1;

        DB.rooms.forEach((r, idx) => {
            if (r.status == 1 && r.type.toLowerCase().includes("kham")) {
                if (bestRoom === null || r.id < bestRoom.id) { // String comparison for ID works like C++ string compare
                    bestRoom = r;
                    bestRoomIdx = idx;
                }
            }
        });

        if (!bestRoom) {
            alert("Hiện tại đã hết phòng khám trống (hoặc chưa có phòng loại 'Kham')!");
            return;
        }

        // 3. Update
        DB.rooms[bestRoomIdx].status = 0;
        DB.schedules.push({
            date: date,
            docId: docId,
            patId: patId,
            roomId: bestRoom.id
        });

        saveDB();
        renderView('schedules');
        showToast(`Đặt thành công! Phòng: ${bestRoom.id}`);
        
        // Auto export schedules and rooms
        exportFile('schedules');
        setTimeout(() => exportFile('rooms'), 1000); // Small delay to avoid browser blocking multiple downloads
    }

    // --- FILE I/O (TXT PIPE DELIMITED) ---

    function handleFileUpload(input, type) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split(/\r?\n/);
            const newItems = [];

            lines.forEach(line => {
                if (!line.trim()) return;
                const parts = line.split('|');
                
                // Matches C++ format structure
                if (type === 'doctors' && parts.length >= 7) {
                    newItems.push({
                        id: parts[0], name: parts[1], dob: parts[2], addr: parts[3],
                        phone: parts[4], pos: parts[5], salary: parts[6], spec: parts[7] || ''
                    });
                } else if (type === 'patients' && parts.length >= 7) {
                    newItems.push({
                        id: parts[0], name: parts[1], dob: parts[2], addr: parts[3],
                        phone: parts[4], diag: parts[5], blood: parts[6]
                    });
                } else if (type === 'employees' && parts.length >= 6) {
                     newItems.push({
                        id: parts[0], name: parts[1], dob: parts[2], addr: parts[3],
                        phone: parts[4], pos: parts[5], salary: parts[6]
                    });
                } else if (type === 'rooms' && parts.length >= 3) {
                     newItems.push({
                        id: parts[0], type: parts[1], status: parts[2].trim() == '1' ? 1 : 0
                    });
                } else if (type === 'schedules' && parts.length >= 4) {
                    newItems.push({
                        date: parts[0], docId: parts[1], patId: parts[2], roomId: parts[3]
                    });
                }
            });

            if (newItems.length > 0) {
                if(confirm(`Tìm thấy ${newItems.length} mục trong file. Bấm OK để cập nhật hệ thống.`)) {
                    // Update Memory & LocalStorage
                    DB[type] = newItems;
                    saveDB();
                    showToast(`Đã nhập thành công dữ liệu ${type}!`);
                    renderView(type);
                    input.value = ''; 
                }
            } else {
                alert("File không đúng định dạng hoặc rỗng!");
            }
        };
        reader.readAsText(file);
    }

    function exportFile(type) {
        let content = "";
        let filename = `${type}.txt`;

        if (type === 'doctors') {
            content = DB.doctors.map(d => `${d.id}|${d.name}|${d.dob}|${d.addr}|${d.phone}|${d.pos}|${d.salary}|${d.spec}`).join('\n');
            filename = 'doctor.txt'; 
        } else if (type === 'patients') {
            content = DB.patients.map(p => `${p.id}|${p.name}|${p.dob}|${p.addr}|${p.phone}|${p.diag}|${p.blood}`).join('\n');
            filename = 'patient.txt'; // Updated per user request
        } else if (type === 'employees') {
            content = DB.employees.map(e => `${e.id}|${e.name}|${e.dob}|${e.addr}|${e.phone}|${e.pos}|${e.salary}`).join('\n');
            filename = 'employee.txt';
        } else if (type === 'rooms') {
            content = DB.rooms.map(r => `${r.id}|${r.type}|${r.status}`).join('\n');
            filename = 'rooms.txt';
        } else if (type === 'schedules') {
            content = DB.schedules.map(s => `${s.date}|${s.docId}|${s.patId}|${s.roomId}`).join('\n');
            filename = 'schedule.txt';
        }

        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.classList.remove('translate-y-40', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-40', 'opacity-0'), 3000);
    }

    // Init App
    initDB();

</script>
</body>

</html>
